project(dcdr-interconnect-flatbuffers)

set(DCDR_FLATBUFFERS_INPUT_FILES
		${PROJECT_SOURCE_DIR}/types.fbs
		${PROJECT_SOURCE_DIR}/commander_request.fbs
		${PROJECT_SOURCE_DIR}/commander_response.fbs
		${PROJECT_SOURCE_DIR}/worker_request.fbs
		${PROJECT_SOURCE_DIR}/worker_response.fbs
		${PROJECT_SOURCE_DIR}/parcel.fbs)

set(DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER ${CMAKE_BINARY_DIR}/gen/flatbuffers)
set(DCDR_FLATBUFFERS_GENERATED_CPP_ROOT_FOLDER ${CMAKE_BINARY_DIR}/gen/flatbuffers/cpp)
set(DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER ${CMAKE_BINARY_DIR}/gen/flatbuffers/cpp/flatbuffers-generated)

set(DCDR_FLATBUFFERS_GENERATED_CPP_FILE ${DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER}/DcdrFlatBuffers.h)

set(DCDR_FLATBUFFERS_GENERATED_FILES
        ${DCDR_FLATBUFFERS_GENERATED_CPP_FILE})

if(WIN32)
    set(CAT_COMMAND type)
	set(MOVE_COMMAND move)
else()
    set(CAT_COMMAND cat)
	set(MOVE_COMMAND mv)
endif()

# type command requires backslashes
if(WIN32) 
	set(DCDR_FLATBUFFERS_INPUT_FILES_OLD ${DCDR_FLATBUFFERS_INPUT_FILES})
	set(DCDR_FLATBUFFERS_INPUT_FILES)
	foreach(_CURRENT_OLD_PATH ${DCDR_FLATBUFFERS_INPUT_FILES_OLD})
		string(REPLACE "/" "\\" _CURRENT_NEW_PATH ${_CURRENT_OLD_PATH})
		list(APPEND DCDR_FLATBUFFERS_INPUT_FILES ${_CURRENT_NEW_PATH})
	endforeach()
endif()

file(MAKE_DIRECTORY ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER})
file(MAKE_DIRECTORY ${DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER})

add_custom_command(
        OUTPUT ${DCDR_FLATBUFFERS_GENERATED_FILES}

        COMMAND echo "${CAT_COMMAND} ${DCDR_FLATBUFFERS_INPUT_FILES_ARGS} > ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER}/DcdrFlatBuffers.fbs"
        COMMAND echo "${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/flatc --cpp ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER}/DcdrFlatBuffers.fbs"
        COMMAND echo "mv DcdrFlatBuffers_generated.h  ${DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER}/DcdrFlatBuffers.h"
		
        COMMAND ${CAT_COMMAND} ${DCDR_FLATBUFFERS_INPUT_FILES} > ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER}/DcdrFlatBuffers.fbs
        COMMAND ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/flatc --cpp --gen-name-strings ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER}/DcdrFlatBuffers.fbs
        COMMAND ${MOVE_COMMAND} DcdrFlatBuffers_generated.h  ${DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER}/DcdrFlatBuffers.h
		
        DEPENDS flatc ${DCDR_FLATBUFFERS_INPUT_FILES}		
		VERBATIM)

add_custom_target(${PROJECT_NAME}
        DEPENDS ${DCDR_FLATBUFFERS_GENERATED_FILES})