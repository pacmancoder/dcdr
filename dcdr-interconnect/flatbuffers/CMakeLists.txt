project(dcdr-interconnect-flatbuffers)

file(GLOB DCDR_FLATBUFFERS_INPUT_FILES ${PROJECT_SOURCE_DIR}/*.fbs)

set(DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER ${CMAKE_BINARY_DIR}/gen/flatbuffers)
set(DCDR_FLATBUFFERS_GENERATED_CPP_ROOT_FOLDER ${CMAKE_BINARY_DIR}/gen/flatbuffers/cpp)
set(DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER ${CMAKE_BINARY_DIR}/gen/flatbuffers/cpp/flatbuffers-generated)
set(DCDR_FLATBUFFERS_GENERATED_JS_FOLDER ${CMAKE_BINARY_DIR}/gen/flatbuffers/js)

set(DCDR_FLATBUFFERS_GENERATED_CPP_FILE ${DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER}/DcdrFlatBuffers.h)
set(DCDR_FLATBUFFERS_GENERATED_JS_FILE ${DCDR_FLATBUFFERS_GENERATED_JS_FOLDER}/DcdrFlatBuffers.js)

set(DCDR_FLATBUFFERS_GENERATED_FILES
        ${DCDR_FLATBUFFERS_GENERATED_CPP_FILE}
        ${DCDR_FLATBUFFERS_GENERATED_JS_FILE})

IF (WIN32)
    set(MKDIR_COMMAND mkdir)
    set(CAT_COMMAND type)
ELSE()
    set(MKDIR_COMMAND mkdir -p)
    set(CAT_COMMAND cat)
ENDIF()

add_custom_command(
        OUTPUT ${DCDR_FLATBUFFERS_GENERATED_FILES}
        COMMAND ${MKDIR_COMMAND} ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER}
        COMMAND ${CAT_COMMAND} ${DCDR_FLATBUFFERS_INPUT_FILES} > ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER}/DcdrFlatBuffers.fbs
        COMMAND ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/flatc --cpp ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER}/DcdrFlatBuffers.fbs
        COMMAND ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/flatc --js  ${DCDR_FLATBUFFERS_GENERATED_ROOT_FOLDER}/DcdrFlatBuffers.fbs
        COMMAND ${MKDIR_COMMAND} ${DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER}
        COMMAND ${MKDIR_COMMAND} ${DCDR_FLATBUFFERS_GENERATED_JS_FOLDER}
        COMMAND mv DcdrFlatBuffers_generated.h  ${DCDR_FLATBUFFERS_GENERATED_CPP_FOLDER}/DcdrFlatBuffers.h
        COMMAND mv DcdrFlatBuffers_generated.js ${DCDR_FLATBUFFERS_GENERATED_JS_FOLDER}/DcdrFlatBuffers.js
        DEPENDS flatc ${DCDR_FLATBUFFERS_INPUT_FILES})

add_custom_target(${PROJECT_NAME}
        DEPENDS ${DCDR_FLATBUFFERS_GENERATED_FILES})

set_property(TARGET ${PROJECT_NAME} PROPERTY GENERATED_JS_FILE ${DCDR_FLATBUFFERS_GENERATED_JS_FILE})